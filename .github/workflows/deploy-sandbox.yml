name: Deploy to Sandbox

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'app.json'
  workflow_dispatch:

permissions:
  contents: read
  actions: read

defaults:
  run:
    shell: powershell

env:
  BC_ENVIRONMENT: DEVRB

jobs:
  build-and-deploy:
    name: Build and Deploy to Sandbox
    runs-on: windows-latest
    environment:
      name: sandbox-devrb

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Read app.json
        id: app-info
        run: |
          $appJson = Get-Content -Path "app.json" -Raw | ConvertFrom-Json
          echo "APP_NAME=$($appJson.name)" >> $env:GITHUB_OUTPUT
          echo "APP_VERSION=$($appJson.version)" >> $env:GITHUB_OUTPUT
          echo "APP_PUBLISHER=$($appJson.publisher)" >> $env:GITHUB_OUTPUT

      - name: Install BcContainerHelper
        run: |
          Install-Module BcContainerHelper -Force -AllowClobber
          Import-Module BcContainerHelper
          Write-Host "BcContainerHelper version: $((Get-Module BcContainerHelper).Version)"

      - name: Build Extension
        run: |
          Import-Module BcContainerHelper

          # Get BC artifact URL
          $artifactUrl = Get-BcArtifactUrl -type OnPrem -country us -select Latest
          Write-Host "Using BC artifact: $artifactUrl"

          # Download artifacts
          Download-Artifacts -artifactUrl $artifactUrl -basePath $env:TEMP -includePlatform

          # Find alc.exe
          $alcPath = Get-ChildItem -Path $env:TEMP -Recurse -Filter "alc.exe" | Select-Object -First 1

          if (-not $alcPath) {
              Write-Host "::error::Could not find alc.exe"
              exit 1
          }

          # Create output folder
          New-Item -ItemType Directory -Path ".output" -Force | Out-Null

          # Get app info
          $appJson = Get-Content -Path "app.json" -Raw | ConvertFrom-Json
          $appFileName = "$($appJson.publisher)_$($appJson.name)_$($appJson.version).app"

          # Compile
          Write-Host "Compiling AL extension..."
          & $alcPath.FullName /project:$PWD /packagecachepath:.alpackages /out:.output\$appFileName

          if ($LASTEXITCODE -ne 0) {
              Write-Host "::error::Compilation failed"
              exit $LASTEXITCODE
          }

          Write-Host "Built: $appFileName"

      - name: Deploy to BC Sandbox
        env:
          AUTH_CONTEXT: ${{ secrets.BC_AUTH_CONTEXT }}
        run: |
          Import-Module BcContainerHelper

          $authContext = $env:AUTH_CONTEXT | ConvertFrom-Json

          # Get the .app file
          $appFile = Get-ChildItem -Path ".output" -Filter "*.app" | Select-Object -First 1

          if (-not $appFile) {
              Write-Host "::error::No .app file found"
              exit 1
          }

          Write-Host "Deploying $($appFile.Name) to ${{ env.BC_ENVIRONMENT }}..."

          # Publish to BC Online
          Publish-BcContainerApp `
              -bcAuthContext $authContext `
              -environment ${{ env.BC_ENVIRONMENT }} `
              -appFile $appFile.FullName `
              -syncMode ForceSync `
              -install `
              -upgrade

          Write-Host "Deployment complete!"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: deploy-${{ steps.app-info.outputs.APP_VERSION }}-${{ github.run_number }}
          path: .output/*.app
          retention-days: 90

      - name: Deployment Summary
        run: |
          Write-Host "================================================"
          Write-Host "Deployment Complete"
          Write-Host "================================================"
          Write-Host "App: ${{ steps.app-info.outputs.APP_NAME }}"
          Write-Host "Version: ${{ steps.app-info.outputs.APP_VERSION }}"
          Write-Host "Environment: ${{ env.BC_ENVIRONMENT }}"
          Write-Host "================================================"
