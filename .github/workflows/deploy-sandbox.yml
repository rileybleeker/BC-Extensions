name: Deploy to Sandbox

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'app.json'
      - '.github/workflows/deploy-sandbox.yml'
  workflow_dispatch:

permissions:
  contents: read
  actions: read

defaults:
  run:
    shell: powershell

env:
  BC_ENVIRONMENT: DEVRB

jobs:
  build-and-deploy:
    name: Build and Deploy to Sandbox
    runs-on: windows-latest
    environment:
      name: sandbox-devrb

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Read app.json
        id: app-info
        run: |
          $appJson = Get-Content -Path "app.json" -Raw | ConvertFrom-Json
          echo "APP_NAME=$($appJson.name)" >> $env:GITHUB_OUTPUT
          echo "APP_VERSION=$($appJson.version)" >> $env:GITHUB_OUTPUT
          echo "APP_PUBLISHER=$($appJson.publisher)" >> $env:GITHUB_OUTPUT

      - name: Install BcContainerHelper
        run: |
          Install-Module BcContainerHelper -Force -AllowClobber
          Import-Module BcContainerHelper
          Write-Host "BcContainerHelper version: $((Get-Module BcContainerHelper).Version)"

      - name: Build Extension
        run: |
          Import-Module BcContainerHelper

          # Get BC artifact URL
          $artifactUrl = Get-BcArtifactUrl -type Sandbox -country us -select Latest
          Write-Host "Using BC artifact: $artifactUrl"

          # Create compiler folder
          $compilerFolder = New-BcCompilerFolder -artifactUrl $artifactUrl -cacheFolder (Join-Path $env:TEMP "cache")
          Write-Host "Compiler folder: $compilerFolder"

          # Find alc.exe
          $alcPath = Join-Path $compilerFolder "alc.exe"
          if (-not (Test-Path $alcPath)) {
              $alcFile = Get-ChildItem -Path $compilerFolder -Recurse -Filter "alc.exe" | Select-Object -First 1
              if ($alcFile) {
                  $alcPath = $alcFile.FullName
              } else {
                  Write-Host "::error::Could not find alc.exe"
                  exit 1
              }
          }

          Write-Host "Found AL compiler: $alcPath"

          # Create output folder
          New-Item -ItemType Directory -Path ".output" -Force | Out-Null

          # Get app info and compile
          $appJson = Get-Content -Path "app.json" -Raw | ConvertFrom-Json
          $appFileName = "$($appJson.publisher)_$($appJson.name)_$($appJson.version).app"

          Write-Host "Compiling..."
          Write-Host "alc.exe /project:$PWD /packagecachepath:$compilerFolder /out:.output\$appFileName"
          & $alcPath /project:"$PWD" /packagecachepath:"$compilerFolder" /out:".output\$appFileName"

          if ($LASTEXITCODE -ne 0) {
              Write-Host "::error::Compilation failed"
              exit $LASTEXITCODE
          }

          Write-Host "Built: $appFileName"

          # Verify the file exists
          $appPath = ".output\$appFileName"
          if (Test-Path $appPath) {
              Write-Host "Verified: $appPath exists ($(Get-Item $appPath).Length bytes)"
              Get-ChildItem ".output"
          } else {
              Write-Host "::error::App file not found at $appPath"
              Get-ChildItem "." -Recurse -Filter "*.app" | ForEach-Object { Write-Host "Found: $($_.FullName)" }
              exit 1
          }

      - name: Deploy to BC Sandbox
        env:
          AUTH_CONTEXT: ${{ secrets.BC_AUTH_CONTEXT }}
        run: |
          Import-Module BcContainerHelper

          # Parse the stored credentials
          $creds = $env:AUTH_CONTEXT | ConvertFrom-Json

          # Create proper auth context using New-BcAuthContext
          $authContext = New-BcAuthContext `
              -tenantID $creds.tenantId `
              -clientID $creds.clientId `
              -clientSecret (ConvertTo-SecureString -String $creds.clientSecret -AsPlainText -Force)

          # Get the .app file
          $appFile = Get-ChildItem -Path ".output" -Filter "*.app" | Select-Object -First 1

          if (-not $appFile) {
              Write-Host "::error::No .app file found"
              exit 1
          }

          Write-Host "Deploying $($appFile.Name) to ${{ env.BC_ENVIRONMENT }}..."
          Write-Host "Tenant ID: $($creds.tenantId)"

          try {
              # Publish to BC Online using Publish-PerTenantExtensionApps for SaaS
              Publish-PerTenantExtensionApps `
                  -bcAuthContext $authContext `
                  -environment "${{ env.BC_ENVIRONMENT }}" `
                  -appFiles @($appFile.FullName) `
                  -schemaSyncMode Force

              Write-Host "Deployment complete!"
          }
          catch {
              Write-Host "::error::Deployment failed: $_"
              Write-Host "Error details: $($_.Exception.Message)"
              if ($_.Exception.Response) {
                  $reader = New-Object System.IO.StreamReader($_.Exception.Response.GetResponseStream())
                  $responseBody = $reader.ReadToEnd()
                  Write-Host "Response body: $responseBody"
              }
              throw
          }

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: deploy-${{ steps.app-info.outputs.APP_VERSION }}-${{ github.run_number }}
          path: .output/*.app
          retention-days: 90

      - name: Deployment Summary
        run: |
          Write-Host "================================================"
          Write-Host "Deployment Complete"
          Write-Host "================================================"
          Write-Host "App: ${{ steps.app-info.outputs.APP_NAME }}"
          Write-Host "Version: ${{ steps.app-info.outputs.APP_VERSION }}"
          Write-Host "Environment: ${{ env.BC_ENVIRONMENT }}"
          Write-Host "================================================"
